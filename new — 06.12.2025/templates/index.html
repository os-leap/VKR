<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏—è–º–∏</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏—è–º–∏</h1>

    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    {% if session.user %}
      <div class="user-info">
        –í—Ö–æ–¥: {{ session.user.username }} ({{ session.user.role }})
        <a href="{{ url_for('logout') }}" class="logout-btn">–í—ã—Ö–æ–¥</a>

        {% if session.user.role == "admin" %}
          <a href="{{ url_for('sync_edsoo_route') }}" class="btn-sync">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</a>
          <a href="{{ url_for('audit_log') }}" class="audit-btn">üìä –ê—É–¥–∏—Ç</a>
        {% endif %}
      </div>
    {% else %}
      <div class="login-link">
        <a href="{{ url_for('login') }}" class="login-btn">–í–æ–π—Ç–∏</a>
      </div>
    {% endif %}

    <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–æ–∏—Å–∫–∞ -->
    <div class="search-panel">
      <form method="GET" action="{{ url_for('search_entry_get') }}">
        <input type="text" name="query" placeholder="–ü–æ–∏—Å–∫..." value="{{ search_query or '' }}" required>
        <input type="hidden" name="topic" value="{{ selected_topic }}">
        <button type="submit">–ò—Å–∫–∞—Ç—å</button>
      </form>
      <a href="{{ url_for('add_entry') }}" class="btn-add">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</a>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–∞–º -->
    <div class="filter-panel">
      <form method="GET" action="{{ url_for('index') }}">
        <label for="topic">–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–º–∞–º:</label>
        <select name="topic" id="topic" onchange="this.form.submit()">
          {% for topic in topics %}
            <option value="{{ topic }}" {% if topic == selected_topic %}selected{% endif %}>
              {{ topic }} {% if topic_stats and topic in topic_stats and topic != '–í—Å–µ —Ç–µ–º—ã' %}({{ topic_stats[topic] }}){% endif %}
            </option>
          {% endfor %}
        </select>
      </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π -->
    {% if entries %}
      <ul class="entries-list">
        {% for entry in entries %}
          <li class="entry-item">
            <div class="entry-header">
              <h2>{{ entry.title }}</h2>
              <div class="entry-meta">
                <span>–¢–µ–º–∞: {{ entry.topic }}</span>
                <span>–°–æ–∑–¥–∞–Ω–æ: {{ format_date(entry.created_at) }}</span>
                <span>–ò–∑–º–µ–Ω–µ–Ω–æ: {{ format_date(entry.updated_at) }}</span>
                <span>–ê–≤—Ç–æ—Ä: {{ entry.author }}</span>
              </div>
            </div>
            <div class="entry-content">
              <p>{{ entry.content[:200] }}{% if entry.content|length > 200 %}...{% endif %}</p>
              {% if entry.file %}
                <div class="entry-file">
                  <span>üìé –§–∞–π–ª: </span>
                  <a href="{{ url_for('uploaded_file', filename=entry.file) }}" target="_blank">{{ entry.file }}</a>
                </div>
              {% endif %}
            </div>
            <div class="entry-actions">
              <a href="{{ url_for('view_entry', index=loop.index0) }}" class="btn-view">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
              {% if session.user and (entry.author == session.user.username or session.user.role == "admin") %}
                <a href="{{ url_for('edit_entry', index=loop.index0) }}" class="btn-edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{{ url_for('delete_entry', index=loop.index0) }}" class="btn-delete">–£–¥–∞–ª–∏—Ç—å</a>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="no-entries">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
    {% endif %}
  </div>
</body>
</html>