<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏—è–º–∏</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏—è–º–∏</h1>

    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    {% if session.user %}
      <div class="user-info">
        –í—Ö–æ–¥: {{ session.user.username }} ({{ session.user.role }})
        <a href="{{ url_for('logout') }}" class="logout-btn">–í—ã—Ö–æ–¥</a>

        {% if session.user.role == "admin" %}
          <div class="admin-dropdown">
            <button class="admin-btn dropdown-toggle">üîë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
            <div class="dropdown-content">
              <a href="{{ url_for('sync_edsoo_route') }}" class="admin-tool">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</a>
              <a href="{{ url_for('audit_log') }}" class="admin-tool">üìã –°–±–æ—Ä —Å–æ–±—ã—Ç–∏–π</a>
              <a href="{{ url_for('manage_filters') }}" class="admin-tool">üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
              <a href="{{ url_for('manage_users') }}" class="admin-tool">üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</a>
            </div>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="login-link">
        <a href="{{ url_for('login') }}" class="login-btn">–í–æ–π—Ç–∏</a>
      </div>
    {% endif %}

    <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–æ–∏—Å–∫–∞ -->
    <div class="search-panel">
      <form method="GET" action="{{ url_for('search_entry_get') }}">
        <input type="text" name="query" placeholder="–ü–æ–∏—Å–∫..." value="{{ search_query or '' }}" required>
        <input type="hidden" name="topic" value="{{ selected_topic }}">
        <input type="hidden" name="class" value="{{ selected_class }}">
        <input type="hidden" name="parallel" value="{{ selected_parallel }}">
        <input type="hidden" name="subject" value="{{ selected_subject }}">
        <button type="submit">–ò—Å–∫–∞—Ç—å</button>
      </form>
      <a href="{{ url_for('add_entry') }}" class="btn-add prominent">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</a>
      <button type="button" class="toggle-filters-btn" onclick="toggleFilters()">–ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="advanced-filter-panel hidden" id="advancedFilterPanel">
      <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
      <form method="GET" action="{{ url_for('index') }}">
        <div class="filter-grid">
          <div class="filter-group">
            <label for="class">–ö–ª–∞—Å—Å:</label>
            <select name="class" id="class" onchange="this.form.submit()">
              <option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>
              {% for class in available_classes %}
              <option value="{{ class }}" {% if class == selected_class %}selected{% endif %}>
                {{ class }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-group">
            <label for="parallel">–ü–∞—Ä–∞–ª–ª–µ–ª—å:</label>
            <select name="parallel" id="parallel" onchange="this.form.submit()">
              <option value="">–í—Å–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏</option>
              {% for parallel in available_parallels %}
              <option value="{{ parallel }}" {% if parallel == selected_parallel %}selected{% endif %}>
                {{ parallel }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-group">
            <label for="subject">–ü—Ä–µ–¥–º–µ—Ç:</label>
            <select name="subject" id="subject" onchange="this.form.submit()">
              <option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>
              {% for subject in available_subjects %}
              <option value="{{ subject }}" {% if subject == selected_subject %}selected{% endif %}>
                {{ subject }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-group topic-selector">
            <label for="topic">–¢–µ–º–∞:</label>
            <select name="topic" id="topic" onchange="this.form.submit()" class="compact-topic-select">
              {% for topic in topics %}
              <option value="{{ topic }}" {% if topic == selected_topic %}selected{% endif %}>
                {{ topic }} {% if topic_stats and topic in topic_stats and topic != '–í—Å–µ —Ç–µ–º—ã' %}({{ topic_stats[topic] }}){% endif %}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-group date-filter">
            <label for="date_from">–î–∞—Ç–∞ –æ—Ç:</label>
            <input type="date" name="date_from" id="date_from" value="{{ date_from or '' }}" onchange="this.form.submit()">
          </div>

          <div class="filter-group date-filter">
            <label for="date_to">–î–∞—Ç–∞ –¥–æ:</label>
            <input type="date" name="date_to" id="date_to" value="{{ date_to or '' }}" onchange="this.form.submit()">
          </div>
        </div>
      </form>
    </div>

    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="active-filters">
      <strong>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</strong>
      {% if selected_class %}
        <span class="filter-badge">–ö–ª–∞—Å—Å: {{ selected_class }} <a href="{{ url_for('index', parallel=selected_parallel, subject=selected_subject, topic=selected_topic, date_from=date_from, date_to=date_to) }}">√ó</a></span>
      {% endif %}
      {% if selected_parallel %}
        <span class="filter-badge">–ü–∞—Ä–∞–ª–ª–µ–ª—å: {{ selected_parallel }} <a href="{{ url_for('index', class=selected_class, subject=selected_subject, topic=selected_topic, date_from=date_from, date_to=date_to) }}">√ó</a></span>
      {% endif %}
      {% if selected_subject %}
        <span class="filter-badge">–ü—Ä–µ–¥–º–µ—Ç: {{ selected_subject }} <a href="{{ url_for('index', class=selected_class, parallel=selected_parallel, topic=selected_topic, date_from=date_from, date_to=date_to) }}">√ó</a></span>
      {% endif %}
      {% if selected_topic and selected_topic != '–í—Å–µ —Ç–µ–º—ã' %}
        <span class="filter-badge">–¢–µ–º–∞: {{ selected_topic }} <a href="{{ url_for('index', class=selected_class, parallel=selected_parallel, subject=selected_subject, date_from=date_from, date_to=date_to) }}">√ó</a></span>
      {% endif %}
      {% if date_from %}
        <span class="filter-badge">–î–∞—Ç–∞ –æ—Ç: {{ date_from }} <a href="{{ url_for('index', class=selected_class, parallel=selected_parallel, subject=selected_subject, topic=selected_topic, date_to=date_to) }}">√ó</a></span>
      {% endif %}
      {% if date_to %}
        <span class="filter-badge">–î–∞—Ç–∞ –¥–æ: {{ date_to }} <a href="{{ url_for('index', class=selected_class, parallel=selected_parallel, subject=selected_subject, topic=selected_topic, date_from=date_from) }}">√ó</a></span>
      {% endif %}
      {% if selected_class or selected_parallel or selected_subject or (selected_topic and selected_topic != '–í—Å–µ —Ç–µ–º—ã') or date_from or date_to %}
        <a href="{{ url_for('index') }}" class="clear-filters-btn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</a>
      {% endif %}
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π -->
    {% if entries %}
      <ul class="entries-list">
        {% for entry in entries %}
          <li class="entry-item">
            <div class="entry-header">
              <h2>{{ entry.title }}</h2>
              <div class="entry-meta">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö -->
                {% if entry.education_info %}
                  {% if entry.education_info.class %}
                    <span>–ö–ª–∞—Å—Å: {{ entry.education_info.class }}</span>
                  {% endif %}
                  {% if entry.education_info.parallel %}
                    <span>–ü–∞—Ä–∞–ª–ª–µ–ª—å: {{ entry.education_info.parallel }}</span>
                  {% endif %}
                  {% if entry.education_info.subject %}
                    <span>–ü—Ä–µ–¥–º–µ—Ç: {{ entry.education_info.subject }}</span>
                  {% endif %}
                {% endif %}
                
                <span>–¢–µ–º–∞: {{ entry.topic }}</span>
                <span>–°–æ–∑–¥–∞–Ω–æ: {{ format_date(entry.created_at) }}</span>
                <span>–ò–∑–º–µ–Ω–µ–Ω–æ: {{ format_date(entry.updated_at) }}</span>
                <span>–ê–≤—Ç–æ—Ä: {{ entry.author }}</span>
              </div>
            </div>
            <div class="entry-content">
              <p>{{ entry.content[:200] }}{% if entry.content|length > 200 %}...{% endif %}</p>
              {% if entry.file %}
                <div class="entry-file">
                  <span>üìé –§–∞–π–ª: </span>
                  <a href="{{ url_for('uploaded_file', filename=entry.file) }}" target="_blank">{{ entry.file }}</a>
                </div>
              {% endif %}
            </div>
            <div class="entry-actions">
              <a href="{{ url_for('view_entry_by_id', entry_id=entry.id) }}" class="btn-view">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
              {% if session.user and (entry.author == session.user.username or session.user.role == "admin") %}
                <a href="{{ url_for('edit_entry_by_id', entry_id=entry.id) }}" class="btn-edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                <a href="{{ url_for('delete_entry_by_id', entry_id=entry.id) }}" class="btn-delete">–£–¥–∞–ª–∏—Ç—å</a>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="no-entries">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
    {% endif %}
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const dropdownToggle = document.querySelector('.dropdown-toggle');
      const dropdownContent = document.querySelector('.dropdown-content');
      
      dropdownToggle.addEventListener('click', function(e) {
        e.preventDefault();
        dropdownContent.classList.toggle('show');
        
        // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–µ–Ω—é —É–±–∏—Ä–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
        if (!dropdownContent.classList.contains('show')) {
          const adminTools = dropdownContent.querySelectorAll('.admin-tool');
          adminTools.forEach(tool => {
            tool.style.animationDelay = '0s';
          });
        } else {
          // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–µ–Ω—é –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
          const adminTools = dropdownContent.querySelectorAll('.admin-tool');
          adminTools.forEach((tool, index) => {
            tool.style.animationDelay = (index * 0.05) + 's';
          });
        }
      });
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏
      document.addEventListener('click', function(e) {
        if (!dropdownToggle.contains(e.target) && !dropdownContent.contains(e.target)) {
          dropdownContent.classList.remove('show');
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
          const adminTools = dropdownContent.querySelectorAll('.admin-tool');
          adminTools.forEach(tool => {
            tool.style.animationDelay = '0s';
          });
        }
      });
    });

    function toggleFilters() {
      const filterPanel = document.getElementById('advancedFilterPanel');
      filterPanel.classList.toggle('hidden');
    }
  </script>
</body>
</html>